<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Game - Shattered Timeline</title>
  <link rel="stylesheet" href="./styles/main.css" />
</head>

<body class="game-page">
  <header class="game-header">
    <span id="welcome-msg">Welcome to Shattered Timeline</span>
    <button id="logout-btn" onclick="handleLogout()">Logout</button>
  </header>
  <main>
    <div id="status">Checking authentication...</div>
    <canvas id="gameCanvas" style="display: none;"></canvas>
  </main>

  <script type="module">
    import { API_CONFIG } from './config.js';
    
    const status = document.getElementById('status');
    const welcomeMsg = document.getElementById('welcome-msg');
    const gameCanvas = document.getElementById('gameCanvas');

    // Check authentication first
    function checkAuthentication() {
      const isLoggedIn = localStorage.getItem('isLoggedIn');
      const userId = localStorage.getItem('userId');
      const sessionToken = localStorage.getItem('sessionToken');

      if (isLoggedIn !== 'true' || !userId || !sessionToken) {
        status.textContent = 'Not authenticated. Redirecting to login...';
        setTimeout(() => {
          window.location.href = './login.html';
        }, 2000);
        return false;
      }

      return true;
    }

    // Logout function using API endpoint
    window.handleLogout = async function() {
      const sessionToken = localStorage.getItem('sessionToken');
      
      if (!sessionToken) {
        // If no token, just clear local storage and redirect
        clearLocalSession();
        window.location.href = './login.html';
        return;
      }

      try {
        status.textContent = 'Logging out...';
        
        // Call logout endpoint with Bearer token
        const response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.LOGOUT}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${sessionToken}`,
            'Content-Type': 'application/json',
          }
        });

        // Handle successful logout (204 No Content)
        if (response.status === 204) {
          console.log('Logout successful');
        } else if (response.status === 401) {
          console.log('Session was already invalid');
        } else {
          console.warn('Unexpected logout response:', response.status);
        }
        
      } catch (error) {
        console.error('Logout request failed:', error);
        // Continue with local cleanup even if API call fails
      } finally {
        // Always clear local storage and redirect, regardless of API response
        clearLocalSession();
        setTimeout(() => {
          window.location.href = './login.html';
        }, 1000);
      }
    };

    // Clear local session data
    function clearLocalSession() {
      localStorage.removeItem('sessionToken');
      localStorage.removeItem('sessionId');
      localStorage.removeItem('userId');
      localStorage.removeItem('isLoggedIn');
    }

    // Initialize game
    async function initializeGame() {
      if (!checkAuthentication()) {
        return;
      }

      try {
        status.textContent = 'Loading game modules...';

        // Check if main.js exists before trying to import
        const mainJsPath = '../main.js';
        console.log('Attempting to import:', mainJsPath);

        // Try to import the main game module
        const gameModule = await import(mainJsPath);
        console.log('Game module loaded:', gameModule);

        status.textContent = 'Initializing game...';
        gameCanvas.style.display = 'block';
        
        // Since main.js already calls main() automatically, we don't need to call it again
        // The game should start automatically when the module is imported
        status.style.display = 'none'; // Hide status once game is running

      } catch (error) {
        console.error('Detailed game loading error:', error);
        status.textContent = `Error loading game: ${error.message}`;
        status.innerHTML += `<br><small>Check console for more details</small>`;
        
        // Show some debugging info
        const currentPath = window.location.href;
        const expectedMainPath = new URL('../main.js', currentPath).href;
        console.log('Current page URL:', currentPath);
        console.log('Expected main.js URL:', expectedMainPath);
      }
    }

    // Start initialization
    initializeGame();
  </script>
</body>

</html>