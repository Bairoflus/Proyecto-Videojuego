<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game - Shattered Timeline</title>
  <!-- Prevent favicon 404 error -->
  <link rel="icon" href="data:,">
  
  <link rel="stylesheet" href="../css/main.css" />
</head>

<body class="game-page">
  <header class="game-header">
    <span id="welcome-msg">Welcome, username</span>
    <div class="pause-indicator">
      Press <kbd>P</kbd> to pause
    </div>
  </header>
  <main>
    <div id="status">Loading game...</div>
    <canvas id="gameCanvas"></canvas>
  </main>

  <script type="module">
    import { createRun } from '../../utils/api.js';
    import { SimpleAudioManager } from '../../utils/SimpleAudioManager.js';

    const status = document.getElementById('status');

    // Clean up menu music when entering game
    const menuAudioManager = new SimpleAudioManager();
    menuAudioManager.cleanupForGamePage();
    console.log('ðŸŽµ Menu music cleaned up for game page');

    /**
     * Clear all session data for complete logout
     * Issue #7: Enhanced logout flow with comprehensive session cleanup
     */
    function clearAllSessionData() {
      console.log('Clearing all session data...');
      const sessionKeys = [
        'sessionToken',
        'currentUserId',
        'currentSessionId',
        'currentRunId',
        'runCreationFailed'
      ];

      sessionKeys.forEach(key => {
        const value = localStorage.getItem(key);
        if (value) {
          localStorage.removeItem(key);
          console.log(`  Cleared ${key}: ${value}`);
        }
      });

      console.log('Session data cleanup complete');
    }

    /**
     * NEW: Ensure run data exists for gameplay
     */
    async function ensureRunData() {
      const userId = localStorage.getItem('currentUserId');
      const runId = localStorage.getItem('currentRunId');

      if (runId) {
        console.log('Run data exists:', runId);
        return true;
      }

      console.log('No run data found, creating new run...');

      try {
        const runData = await createRun(parseInt(userId));
        localStorage.setItem('currentRunId', runData.runId);
        console.log('New run created successfully:', runData.runId);
        return true;

      } catch (error) {
        console.error('Failed to create run:', error);

        // Set test mode flag
        localStorage.setItem('testMode', 'true');
        console.warn('Running in test mode - some features may be limited');
        return true; // Allow test mode
      }
    }

    /**
     * Validate session data on page load
     */
    function validateSession() {
      const sessionToken = localStorage.getItem('sessionToken');
      const userId = localStorage.getItem('currentUserId');
      const sessionId = localStorage.getItem('currentSessionId');

      if (!sessionToken || !userId || !sessionId) {
        console.warn('Incomplete session data detected, redirecting to login');
        console.log('Session validation failed:', {
          hasSessionToken: !!sessionToken,
          hasUserId: !!userId,
          hasSessionId: !!sessionId
        });

        // Clear any partial session data
        clearAllSessionData();

        // Redirect to login
        window.location.href = 'login.html';
        return false;
      }

      console.log('Session validation passed');
      return true;
    }

    // Validate session before initializing game
    if (validateSession()) {
      // NEW: Initialize game with run data validation
      async function initializeGame() {
        try {
          status.textContent = 'Validating session...';

          // Ensure run data exists
          const runDataReady = await ensureRunData();
          if (!runDataReady) {
            throw new Error('Failed to initialize run data');
          }

          status.textContent = 'Loading modules...';

          // Import main game module
          const { main } = await import('/main.js');

          status.textContent = 'Starting game...';
          main();
          status.style.display = 'none'; // Hide status once game is running

        } catch (error) {
          status.textContent = 'Error loading game: ' + error.message;
          console.error('Game initialization error:', error);
        }
      }

      // Start game initialization
      initializeGame();
    }
  </script>

</body>

</html>