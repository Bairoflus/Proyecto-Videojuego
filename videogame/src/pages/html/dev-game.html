<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>🧪 Developer Game - Shattered Timeline (DEV MODE)</title>
  <link rel="stylesheet" href="../css/main.css" />
  <style>
    /* Developer-specific styling */
    .dev-header {
      background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      position: relative;
    }

    .dev-controls {
      position: fixed;
      top: 60px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      max-width: 300px;
      z-index: 1000;
      border: 2px solid #4ecdc4;
    }

    .dev-controls button {
      margin: 2px;
      padding: 5px 10px;
      background: #4ecdc4;
      color: black;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
    }

    .dev-controls button:hover {
      background: #45b7b8;
    }

    .dev-info {
      background: rgba(255, 107, 107, 0.9);
      color: white;
      padding: 5px 10px;
      margin: 5px 0;
      border-radius: 4px;
      font-weight: bold;
    }

    #status {
      background: rgba(0, 0, 0, 0.8);
      color: #4ecdc4;
      padding: 20px;
      text-align: center;
      font-family: monospace;
      font-size: 16px;
      border: 2px solid #4ecdc4;
      border-radius: 8px;
      margin: 20px auto;
      max-width: 500px;
    }
  </style>
</head>

<body class="game-page">
  <header class="dev-header">
    🧪 DEVELOPER MODE - Shattered Timeline | No Authentication Required | All Debug Tools Active
  </header>

  <!-- Developer Controls Panel -->
  <div class="dev-controls" id="devControls">
    <div class="dev-info">🛠️ DEV TOOLS</div>

    <div style="margin: 10px 0;">
      <strong>Game Controls:</strong><br>
      <button onclick="restartGame()">🔄 Restart Game</button>
      <button onclick="killPlayer()">💀 Kill Player</button>
      <button onclick="godMode()">🛡️ God Mode</button>
      <button onclick="addGold()">💰 +1000 Gold</button>
    </div>

    <div style="margin: 10px 0;">
      <strong>Room Controls:</strong><br>
      <button onclick="forceNextRoom()">➡️ Next Room</button>
      <button onclick="clearEnemies()">⚔️ Clear Enemies</button>
      <button onclick="spawnChest()">📦 Spawn Chest</button>
    </div>

    <div style="margin: 10px 0;">
      <strong>Debug Info:</strong><br>
      <button onclick="showGameState()">📊 Game State</button>
      <button onclick="testRoomMapping()">🗺️ Test Mapping</button>
      <button onclick="checkServices()">🔧 Check Services</button>
    </div>

    <div style="margin: 10px 0;">
      <strong>Session:</strong><br>
      <button onclick="showSessionData()">📋 Session Data</button>
      <button onclick="toggleTestMode()">🧪 Toggle Test Mode</button>
    </div>

    <button onclick="toggleDevPanel()" style="margin-top: 10px; background: #ff6b6b;">❌ Hide Panel</button>
  </div>

  <main>
    <div id="status">🚀 Initializing Developer Game Mode...</div>
    <canvas id="gameCanvas"></canvas>
  </main>

  <script type="module">
    /**
     * DEVELOPER GAME MODE - No Authentication Required
     * This page bypasses all authentication and sets up the game in test mode
     */

    const status = document.getElementById('status');

    /**
     * Setup developer environment with test data
     */
    function setupDeveloperEnvironment() {
      console.log('🧪 SETTING UP DEVELOPER ENVIRONMENT');
      console.log('━'.repeat(60));

      // Clear any existing session data
      const sessionKeys = [
        'sessionToken',
        'currentUserId',
        'currentSessionId',
        'currentRunId',
        'runCreationFailed'
      ];

      sessionKeys.forEach(key => {
        localStorage.removeItem(key);
      });

      // Set up fake developer session data
      localStorage.setItem('testMode', 'true');
      localStorage.setItem('developerMode', 'true');
      localStorage.setItem('currentUserId', '999'); // Fake dev user ID
      localStorage.setItem('currentSessionId', '999'); // Fake dev session ID
      localStorage.setItem('currentRunId', '999'); // Fake dev run ID

      console.log('✅ Developer environment configured');
      console.log('✅ Test mode enabled');
      console.log('✅ Fake session data created');
      console.log('✅ All authentication bypassed');
      console.log('━'.repeat(60));
    }

    /**
     * Initialize game in developer mode
     */
    async function initializeDeveloperGame() {
      try {
        status.textContent = '🛠️ Setting up developer environment...';
        setupDeveloperEnvironment();

        status.textContent = '📦 Loading game modules...';

        // Import main game module
        const { main } = await import('/main.js');

        status.textContent = '🎮 Starting game in developer mode...';
        main();

        // Hide status and show success
        setTimeout(() => {
          status.style.display = 'none';
          console.log('🎉 DEVELOPER GAME MODE READY!');
          showDeveloperWelcome();
        }, 1000);

      } catch (error) {
        status.innerHTML = `
          ❌ <strong>Error loading developer game:</strong><br>
          ${error.message}<br><br>
          <button onclick="location.reload()" style="padding: 10px 20px; font-size: 14px;">
            🔄 Retry
          </button>
        `;
        console.error('Developer game initialization error:', error);
      }
    }

    /**
     * Show developer welcome message
     */
    function showDeveloperWelcome() {
      console.log('🧪 DEVELOPER MODE ACTIVE');
      console.log('━'.repeat(50));
      console.log('🎮 Game is running in full developer mode');
      console.log('🚫 No authentication required');
      console.log('🛠️ All debug tools are active');
      console.log('📊 Check the developer panel on the right →');
      console.log('━'.repeat(50));
      console.log('Available Console Commands:');
      console.log('  gameSessionDebug.check() - Check session data');
      console.log('  gameServiceDebug.status() - Check service status');
      console.log('  testGame() - Run game tests');
      console.log('  window.game - Direct game instance access');
      console.log('━'.repeat(50));
    }

    // Start developer game initialization immediately
    initializeDeveloperGame();
  </script>

  <!-- Load game testing suite - commented out for now -->
  <!-- <script type="module" src="../../browser_game_test.js"></script> -->

  <!-- Developer Tools JavaScript -->
  <script>
    // Global developer functions
    window.devTools = {

      // Game control functions
      restartGame() {
        if (window.game) {
          console.log('🔄 Restarting game...');
          window.game.resetGameAfterDeath();
          console.log('✅ Game restarted');
        } else {
          console.error('❌ Game instance not found');
        }
      },

      killPlayer() {
        if (window.game && window.game.player) {
          console.log('💀 Killing player...');
          window.game.player.health = 0;
          console.log('✅ Player killed');
        } else {
          console.error('❌ Player not found');
        }
      },

      godMode() {
        if (window.game && window.game.player) {
          console.log('🛡️ Activating god mode...');
          window.game.player.health = window.game.player.maxHealth;
          window.game.player.maxHealth = 9999;
          window.game.player.health = 9999;
          console.log('✅ God mode activated - Health set to 9999');
        } else {
          console.error('❌ Player not found');
        }
      },

      addGold() {
        if (window.game && window.game.player) {
          console.log('💰 Adding 1000 gold...');
          window.game.player.gold += 1000;
          console.log(`✅ Gold added - Total: ${window.game.player.gold}`);
        } else {
          console.error('❌ Player not found');
        }
      },

      // Room control functions
      forceNextRoom() {
        if (window.game) {
          console.log('➡️ Forcing next room transition...');
          window.game.handleRoomTransition('right').then(() => {
            console.log('✅ Room transition completed');
          }).catch(error => {
            console.error('❌ Room transition failed:', error);
          });
        } else {
          console.error('❌ Game instance not found');
        }
      },

      clearEnemies() {
        if (window.game && window.game.currentRoom) {
          console.log('⚔️ Clearing all enemies...');
          const enemies = window.game.currentRoom.objects.enemies;
          enemies.forEach(enemy => {
            enemy.health = 0;
            enemy.state = 'dead';
          });
          console.log(`✅ Cleared ${enemies.length} enemies`);
        } else {
          console.error('❌ Current room not found');
        }
      },

      spawnChest() {
        if (window.game && window.game.currentRoom) {
          console.log('📦 Spawning chest...');
          window.game.currentRoom.spawnChest();
          console.log('✅ Chest spawned');
        } else {
          console.error('❌ Current room not found');
        }
      },

      // Debug info functions
      showGameState() {
        if (window.game) {
          const state = {
            floor: window.game.floorGenerator.getCurrentFloor(),
            room: window.game.floorGenerator.getCurrentRoomIndex() + 1,
            roomId: window.game.floorGenerator.getCurrentRoomId(),
            roomType: window.game.floorGenerator.getCurrentRoomType(),
            playerHealth: window.game.player.health,
            playerGold: window.game.player.gold,
            enemies: window.game.currentRoom.objects.enemies.length,
            isTransitioning: window.game.isTransitioning,
            transitionCooldown: window.game.transitionCooldown
          };
          console.log('📊 CURRENT GAME STATE:');
          console.table(state);
        } else {
          console.error('❌ Game instance not found');
        }
      },

      testRoomMapping() {
        console.log('🗺️ Testing room mapping...');
        if (window.testMapping) {
          window.testMapping();
        } else {
          console.error('❌ Room mapping test not available');
        }
      },

      checkServices() {
        console.log('🔧 Checking services...');
        if (window.gameServiceDebug) {
          const status = window.gameServiceDebug.status();
          console.log('Service Status:', status);
        } else {
          console.error('❌ Service debug not available');
        }
      },

      // Session functions
      showSessionData() {
        console.log('📋 CURRENT SESSION DATA:');
        const data = {
          testMode: localStorage.getItem('testMode'),
          developerMode: localStorage.getItem('developerMode'),
          userId: localStorage.getItem('currentUserId'),
          sessionId: localStorage.getItem('currentSessionId'),
          runId: localStorage.getItem('currentRunId')
        };
        console.table(data);
      },

      toggleTestMode() {
        const current = localStorage.getItem('testMode') === 'true';
        localStorage.setItem('testMode', !current);
        console.log(`🧪 Test mode ${!current ? 'ENABLED' : 'DISABLED'}`);
      },

      toggleDevPanel() {
        const panel = document.getElementById('devControls');
        if (panel.style.display === 'none') {
          panel.style.display = 'block';
          console.log('🛠️ Developer panel shown');
        } else {
          panel.style.display = 'none';
          console.log('🛠️ Developer panel hidden');
        }
      }
    };

    // Make functions globally available for buttons
    window.restartGame = window.devTools.restartGame;
    window.killPlayer = window.devTools.killPlayer;
    window.godMode = window.devTools.godMode;
    window.addGold = window.devTools.addGold;
    window.forceNextRoom = window.devTools.forceNextRoom;
    window.clearEnemies = window.devTools.clearEnemies;
    window.spawnChest = window.devTools.spawnChest;
    window.showGameState = window.devTools.showGameState;
    window.testRoomMapping = window.devTools.testRoomMapping;
    window.checkServices = window.devTools.checkServices;
    window.showSessionData = window.devTools.showSessionData;
    window.toggleTestMode = window.devTools.toggleTestMode;
    window.toggleDevPanel = window.devTools.toggleDevPanel;

    // Display developer instructions after game loads
    setTimeout(() => {
      console.log('🧪 DEVELOPER TOOLS READY');
      console.log('━'.repeat(60));
      console.log('Use the panel on the right or these console commands:');
      console.log('  restartGame() - Restart the game');
      console.log('  killPlayer() - Kill player for testing death');
      console.log('  godMode() - Make player invincible');
      console.log('  addGold() - Add 1000 gold');
      console.log('  forceNextRoom() - Force room transition');
      console.log('  clearEnemies() - Kill all enemies');
      console.log('  spawnChest() - Spawn a chest');
      console.log('  showGameState() - Show current game state');
      console.log('  testRoomMapping() - Test room mapping');
      console.log('  checkServices() - Check service status');
      console.log('  showSessionData() - Show session data');
      console.log('  toggleTestMode() - Toggle test mode');
      console.log('  toggleDevPanel() - Toggle developer panel');
      console.log('━'.repeat(60));
      console.log('🎮 READY FOR DEVELOPMENT TESTING!');
    }, 2000);
  </script>
</body>

</html>